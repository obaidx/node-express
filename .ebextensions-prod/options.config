option_settings:
  aws:autoscaling:asg:
    MaxSize: '2'
    MinSize: '1'
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: stage1
  aws:elasticbeanstalk:customoption:
    ELBAlarmEmail: "ubaidx@gmail.com"
    ELBHealthyHostCount: "1"
    ELBLatency: "0.5"
    ELBHTTP5xxErrors: "0"


Resources:
  ELBAlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint:
            Fn::GetOptionSetting:
              OptionName: ELBAlarmEmail
              DefaultValue: "ubaidx@gmail.com"
          Protocol: email
  ELBHealthyHostCountAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: { "Fn::Join" : ["", [{ "Ref" : "AWSEBEnvironmentName" }, ": ELB no healthy backend hosts." ]]}
      Namespace: AWS/ELB
      MetricName: HealthyHostCount
      Dimensions:
        - Name: LoadBalancerName
          Value : { "Ref" : "AWSEBLoadBalancer" }
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 
        Fn::GetOptionSetting:
          OptionName: ELBHealthyHostCount
          DefaultValue: "1"
      ComparisonOperator: LessThanThreshold
      AlarmActions:
        - Ref: ELBAlarmTopic
      InsufficientDataActions:
        - Ref: ELBAlarmTopic
  ELBLatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: { "Fn::Join" : ["", [{ "Ref" : "AWSEBEnvironmentName" }, ": HIGH ELB latency." ]]}
      Namespace: AWS/ELB
      MetricName: Latency
      Dimensions:
        - Name: LoadBalancerName
          Value : { "Ref" : "AWSEBLoadBalancer" }
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 
        Fn::GetOptionSetting:
          OptionName: ELBLatency
          DefaultValue: "0.5"
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - Ref: ELBAlarmTopic
      InsufficientDataActions:
        - Ref: ELBAlarmTopic
  ELBHTTP5xBEAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: { "Fn::Join" : ["", [{ "Ref" : "AWSEBEnvironmentName" }, ": HIGH ELB backend HTTP 5xx error rate." ]]}
      Namespace: AWS/ELB
      MetricName: HTTPCode_Backend_5XX
      Dimensions:
        - Name: LoadBalancerName
          Value : { "Ref" : "AWSEBLoadBalancer" }
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 
        Fn::GetOptionSetting:
          OptionName: ELBHTTP5xxErrors
          DefaultValue: "0"
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - Ref: ELBAlarmTopic
      InsufficientDataActions:
        - Ref: ELBAlarmTopic